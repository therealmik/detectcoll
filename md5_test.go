package detectcoll

import (
	"crypto/subtle"
	"encoding/hex"
	"testing"
)

func TestMD5(t *testing.T) {
	var h Hash = NewMD5()

	var ret []byte

	ret = h.Sum(nil)
	expected, _ := hex.DecodeString("d41d8cd98f00b204e9800998ecf8427e")
	if subtle.ConstantTimeCompare(ret, expected) != 1 {
		t.Errorf("Empty hash incorrect: %x (not %x)", ret, expected)
	}

	// h.Reset()
	h.Write([]byte("abc"))
	expected, _ = hex.DecodeString("900150983cd24fb0d6963f7d28e17f72")
	ret = h.Sum(nil)
	if subtle.ConstantTimeCompare(ret, expected) != 1 {
		t.Errorf("Hash('abc') incorrect: %x (not %x)", ret, expected)
	}
}

func TestMD5Coll(t *testing.T) {
	coll, _ := hex.DecodeString("3c313839342d323735362d333339382e363937372d303334352d3138354070617373776f72645f6465746563746f725f6462632e6d74766965772e63612e7573a41d6e98067d7083dd1d6ea8dbee64e29fe168ffb3a50e12e2d337743d540f60abc5637cd9d9eae91ec5b5a923f609c31e4f53fdadc733adc68003fd6af345772cbebe6c174d9e53d12b346fe9b4e278259c5def4ed32be0bd984d7722067b1f3e4142434445464748494a4b4c4d4e4f505152535455565758595a3031323333")

	var h Hash = NewMD5()
	h.Write(coll)
	sum, detected := h.DetectSum(nil)
	if !detected {
		t.Errorf("No collisions found for hash %x", sum)
	}

	h.Reset()
	coll, _ = hex.DecodeString("3082039ba003020102020309cfc7300d06092a864886f70d0101040500305a310b3009060355040613025553311c301a060355040a1313457175696661782053656375726520496e632e312d302b06035504031324457175696661782053656375726520476c6f62616c2065427573696e6573732043412d31301e170d3038313130333037353230325a170d3039313130343037353230325a3082011c310b300906035504061302555331493047060355040a1340692e62726f6b652e7468652e696e7465726e65742e616e642e616c6c2e692e676f742e7761732e746869732e742d73686972742e7068726565646f6d2e6f726731133011060355040b130a475431313032393030313131302f060355040b1328536565207777772e726170696473736c2e636f6d2f7265736f75726365732f637073202863293038312f302d060355040b1326446f6d61696e20436f6e74726f6c2056616c696461746564202d20526170696453534c2852293149304706035504031340692e62726f6b652e7468652e696e7465726e65742e616e642e616c6c2e692e676f742e7761732e746869732e742d73686972742e7068726565646f6d2e6f726730820122300d06092a864886f70d01010105000382010f003082010a0282010100b2d32581aa28e878b1e50ad53c0f36576ea95f06410e6bb4cb07170000005bfd6b1c7b9ce8a9a3c5450b36bb01d153aac3088f6ff84f3e87874411dc60e0df9255f9b8731b5493c59fd046c460b63562cdb9af1ca86b1ac95b3c9637c0ed67efbbfec08b9c502f29bd83229e8e08faac1370a2587f62628a11f789f6dfb667597316fb63168ab49138ce2ef5b6be4ca49449e465510a4215c9c130e269d5457da526bbb961ec6264f039e1e7bc68d850519e1d60d3d1a3a70af80320a170011791364f0270318683ddf70fd8071d11b31304a5daf0ae50b1280e63692a0c826f8f4733df6ca20692f14f45bed93036a32b8cd677ae35637f4e4c9a934836d99f0203010001a381bd3081ba300e0603551d0f0101ff0404030204f0301d0603551d0e04160414cda683faa56037f796371729de4178f1878955e7303b0603551d1f043430323030a02ea02c862a687474703a2f2f63726c2e67656f74727573742e636f6d2f63726c732f676c6f62616c6361312e63726c301f0603551d23041830168014bea8a07472506b44b7c923d8fba8ffb3576b686c301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000")
	h.Write(coll)
	sum, detected = h.DetectSum(nil)
	if !detected {
		t.Errorf("No collisions found for hash %x", sum)
	}
}
